<!doctype html>
<html>
	<head>
		<meta charset="utf-8" />
		<!-- CHANGE!! Title Refactoring --->
    	<title>SDECE Activity Mapping</title>
    	<meta
      		name="viewport"
      		content="initial-scale=1,maximum-scale=1,user-scalable=no"
    	/>
		
        <!-- Import Montserrat and Hind from Google Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Hind:wght@300;400;500;600;700&display=swap" />

		
		<!-- Load Leaflet from CDN -->
        <link
        	rel="stylesheet"
        	href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
        	integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
        	crossorigin=""
        />
        <script
        	src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
        	integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
        	crossorigin=""
        ></script>

        <!-- Load Esri Leaflet from CDN -->
        <script
        	src="https://unpkg.com/esri-leaflet@2.4.1/dist/esri-leaflet.js"
        	integrity="sha512-xY2smLIHKirD03vHKDJ2u4pqeHA7OQZZ27EjtqmuhDguxiUvdsOuXMwkg16PQrm9cgTmXtoxA6kwr8KBy3cdcw=="
        	crossorigin=""
        ></script>

        <!-- Load Esri Leaflet Geocoder from CDN -->
        <link
        	rel="stylesheet"
        	href="https://unpkg.com/esri-leaflet-geocoder@2.3.3/dist/esri-leaflet-geocoder.css"
        	integrity="sha512-IM3Hs+feyi40yZhDH6kV8vQMg4Fh20s9OzInIIAc4nx7aMYMfo+IenRUekoYsHZqGkREUgx0VvlEsgm7nCDW9g=="
        	crossorigin=""
        />
        <script
        	src="https://unpkg.com/esri-leaflet-geocoder@2.3.3/dist/esri-leaflet-geocoder.js"
        	integrity="sha512-HrFUyCEtIpxZloTgEKKMq4RFYhxjJkCiF5sDxuAokklOeZ68U2NPfh4MFtyIVWlsKtVbK5GD2/JzFyAfvT5ejA=="
        	crossorigin=""
        ></script>

		<!-- Load CSS stylesheet -->
        <link href="./css/main.css" rel="stylesheet" />

        <!-- <link href="./src/output.css" rel="stylesheet" /> -->
        <!--<script type="module" src="js/firestore.js"></script>-->
	</head>

	<body>
		<!-- MAIN CONTENT -->
        <div class="main">

			<!-- Navigation bar -->
        	<div class="side-nav">

				<!-- Navigation bar search bar and filters -->
				<div class="side-nav-header">
					<div class="search-bar-container">
						<div class="search-bar">
							<input id="search-input" class="search-input-field" onkeyup="onSearchInput()" type="text" placeholder="Search..." />
							<div class="search-bar-btn-container">
								<!-- Search bar icons -->
								<button>
									<svg class="search-btn" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" >
										<path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"/>
									</svg>
								</button>
								<!-- Clear Search Bar X Button -->
								<!-- CHANGE! id name not conforming with naming conventions -->
								<button id="searchClear" onclick="clearSearch()" style="padding-left: 1.25rem; display: none" >
									<svg class="search-btn" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" >
										<path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
									</svg>
								</button>
							</div>
						</div>
					</div>
				</div>

				<!-- List of entries -->
				<div class="entries">
					<ul id="locationList" style="width: 100%"></ul>
				</div>

        	</div>
			
			<!-- Right container containing Login/Logout header and map -->
        	<div class="main-container">

				<!-- Login/Logout header -->
				<div class="main-header">

					<!-- Layer Toggle -->
					<div class="layer-toggle-container">
						<svg class="bi bi-layers layers-icon"  xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 16 16" >
							<path d="M8.235 1.559a.5.5 0 0 0-.47 0l-7.5 4a.5.5 0 0 0 0 .882L3.188 8 .264 9.559a.5.5 0 0 0 0 .882l7.5 4a.5.5 0 0 0 .47 0l7.5-4a.5.5 0 0 0 0-.882L12.813 8l2.922-1.559a.5.5 0 0 0 0-.882zm3.515 7.008L14.438 10 8 13.433 1.562 10 4.25 8.567l3.515 1.874a.5.5 0 0 0 .47 0zM8 9.433 1.562 6 8 2.567 14.438 6z"/>
						</svg>
						<select id="collections" class="layer-toggle" name="collections"></select>
					</div>

					<!-- Logout Button -->
					<button class="logout-btn">
						<svg class="logout-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" >
							<path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m3 0 3-3m0 0-3-3m3 3H9" />
						</svg>
						Logout
					</button>

            	</div>

				<!-- Map container -->
            	<div id="map" class="map-container"></div>

        	</div>

        </div>

        <!-- MODALS -->

		<!-- CHANGE! Should only have one Main modal -->
        <!-- Partner Modal: This is the modal that shows up when clicking on an SDECE entry in the side navigation panel OR the pop-up of a map marker pin. -->
        <!-- CHANGE! id name should conform with naming conventions -->
		<div id="partnerModal" class="modal">

        	<!-- Modal Header -->
        	<div class="modal-header">
            	<p id="modalHeader"></p> <!-- NOTE: This is where the Entry modal Header should go -->
          	</div>

        	<!-- Modal Content -->
        	<div id="modalContent" class="modal-content"></div> <!-- NOTE: This is where all Entry modal content shoul go (ie. Households for Buklod-Tao, Partners for SDECE) -->

        	<!-- Buttons -->
        	<span class="modal-button">
            	<!-- Edit -->
            	<button class="edit-button partner-hover">
              		Edit
              		<svg class="modal-button-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" >
                		<path d="M20,16v4a2,2,0,0,1-2,2H4a2,2,0,0,1-2-2V6A2,2,0,0,1,4,4H8" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" ></path>
                		<polygon fill="none" points="12.5 15.8 22 6.2 17.8 2 8.3 11.5 8 16 12.5 15.8" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" ></polygon>
              		</svg>
            	</button>
        	</span>

        </div>

        <!-- Main Modal: This is the modal that shows up when pressing the main button in the side navigation panel. -->
        <!-- CHANGE! id name should conform with naming conventions -->
		<div id="mainModal" class="modal-screen" >
          <iframe
            src="/app_sdece/html/main_modal.html"
            class="main-modal"
            id="mainModalIframe"
          ></iframe>
        </div>

        <!-- Add Modal: This is the modal that shows up when clicking on the '+' sign that is nested inside the Main Modal. This allows the user to add a new activity to the SDECE collections. -->
        <!-- CHANGE! id name should conform with naming conventions -->
		<div id="addModal" class="modal-screen" >
			<!-- CHANGE! id name should conform with naming conventions -->
			<iframe id="addModalHTML" class="form-modal" src="/app_sdece/html/addloc.html"></iframe>
        </div>

        <!-- Edit Modal: This is the modal that shows up when clicking on the Edit button that is nested within Partner Modal. This allows the user to edit an existing activity within the SDECE Collections. -->
        <!-- CHANGE! id name should conform with naming conventions -->
		<div id="editModal" class="modal-screen" >
			<!-- CHANGE! id name should conform with naming conventions -->
        	<iframe id="editModalHTML" class="form-modal" src="/app_sdece/html/editloc.html" class="form-modal" ></iframe>
        </div>

        <!-- Message Modal: This is the modal that displays a message. Used to indicate form submission/deletion success -->
        <div class="modal-screen" id="messageModal">
        	<iframe class="message-modal" src="/app_sdece/html/message_modal.html" ></iframe>
        </div>
		
	</body>

	<!-- Module for the implementation of the Rules Engine for switching maps -->
	<script type="module">
		//Importing functions from other files
		import {
            setCollection,
            getCollection,
            DB_RULES_AND_DATA,
        } from "/js/firestore_UNIV.js";
        import {
            readyField,
            clearMarkers,
            clearLocationList,
            map,
            loadJsCssFiles,
            createJsCssFiles,
        } from "/js/index_UNIV.js";
        import {
            getDocs,
            query,
        } from "https://www.gstatic.com/firebasejs/9.18.0/firebase-firestore.js";
        import {
            getCurrentBranchCookie,
            setCurrentBranchCookie,
        } from "/js/cookies.js";

		//Code logic
        var collections = document.getElementById("collections");

        for (let rule of DB_RULES_AND_DATA) {
            collections.innerHTML += `<option value="${
              rule[0]
            }"> ${readyField(rule[0])}</option>`;
        }

        collections.addEventListener("change", function () {
            const SELECTED = collections.options[collections.selectedIndex].value;
			setCurrentBranchCookie("current_branch", SELECTED);

			if (collections.selectedIndex === 0) {
				// First layer selected â€” go to Buklod Tao app
				window.location.href = "app_buklod-tao/index.html";
			} else {
				// Stay in current app
				setCollection(SELECTED);
				location.reload();
			}
        });


        if (getCurrentBranchCookie() === null) {
            setCollection(DB_RULES_AND_DATA[0][0]);
            setCurrentBranchCookie("current_branch", DB_RULES_AND_DATA[0][0]);
            loadJsCssFiles(getCurrentBranchCookie());
        } else {
            setCollection(getCurrentBranchCookie());
            collections.value = getCurrentBranchCookie();
            loadJsCssFiles(getCurrentBranchCookie());
		}
	</script>

	<!-- SCRIPTS -->
	<script>
		// This hides the Add Activity modal when the user submits the form
        window.addEventListener("message", function (event) {
        	if (event.data && event.data.type === "addlocFormSuccess") {
            	const addModal = document.getElementById("addModal");	// Handle successful form submission event here
            	addModal.classList.add("hidden");	// Hide the iframe
        	}

            if (event.data && event.data.type === "mainModalFormSuccess") {
            	const messageModal = document.getElementById("messageModal");	// Handle successful form submission event here
            	messageModal.style.display = "flex";	//display success message

            	setTimeout(() => {
					messageModal.style.display = "none";
            	}, 3000);
            }
        });

        function onSearchInput() {
            let input = document
            	.getElementById("search-input")
            	.value.toLowerCase();

            var button = document.getElementById("searchClear");

            // Show the button if input is not empty, hide it otherwise
            if (input !== "") {
            	button.style.display = "flex";
            } else {
            	button.style.display = "none";
            }

            let container = document.getElementById("locationList");
            let partnerContainers = container.getElementsByClassName("partnerDiv");

            for (let i = 0; i < partnerContainers.length; i++) {
            	let nameElement = partnerContainers[i].getElementsByClassName("name")[0];
            	let name = nameElement.textContent.toLowerCase();

            	let current_container = partnerContainers[i];
            	if (name.includes(input)) {
                	partnerContainers[i].style.display = "flex";
              	} else {
                	partnerContainers[i].style.display = "none";
              	}
            }
        }

        function clearSearch() {
        	var input = document.getElementById("search-input");
        	input.value = "";
        	onSearchInput();
        }

        // Function to hide the div containing the iframe
        function hideModalContainer(modal) {
        	var iframe = document.getElementById(modal);
        	if (iframe) {
            	iframe.style.display = "none";
            }
        }

        // Add an event listener to handle messages from the iframe
        window.addEventListener("message", function (event) {
        	if (event.data === "closeAddModal") {
            	hideModalContainer("addModal");
        	}
        	if (event.data === "closeEditModal") {
            	hideModalContainer("editModal");
            }
            if (event.data === "closeMainModal") {
            	hideModalContainer("mainModal");
            }
            if (event.data === "closeMessageModal") {
            	hideModalContainer("messageModal");
            }
        });
	
	</script>

</html>